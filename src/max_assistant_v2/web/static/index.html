<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FRANK</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#1f6feb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FRANK">
<link rel="apple-touch-icon" href="/static/icon-192.png">

<style>
body {
    margin: 0;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    background: #0f111a;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
}

h1 {
    margin-top: 50px;
    letter-spacing: 4px;
}

#status {
    margin-top: 20px;
    opacity: 0.7;
}

#response {
    margin: 30px;
    font-size: 18px;
    min-height: 80px;
}

.mic-btn {
    margin: 40px auto;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: #1f6feb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    cursor: pointer;
    transition: 0.3s;
}

.mic-btn.listening {
    animation: pulse 1s infinite;
    background: #ff4c4c;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

#splash {
    position: fixed;
    inset: 0;
    background: #0f111a;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    letter-spacing: 6px;
    z-index: 9999;
    transition: opacity 0.6s ease;
}

#frank-state {
    margin-top: 15px;
    font-size: 14px;
    opacity: 0.6;
}
</style>
</head>

<body>

<div id="splash">
  <h1>FRANK</h1>
</div>

<h1>FRANK</h1>
<div id="status">PR√äT</div>
<div id="response"></div>
<div class="mic-btn" id="mic">üé§</div>
<div id="frank-state">CALME</div>

<script>

const TOKEN = "frank-local-token";
const micBtn = document.getElementById("mic");
const statusDiv = document.getElementById("status");
const responseDiv = document.getElementById("response");
const stateDiv = document.getElementById("frank-state");

let mediaRecorder;
let audioChunks = [];
let isRecording = false;

/* Splash */
window.addEventListener("load", () => {
    setTimeout(() => {
        const splash = document.getElementById("splash");
        splash.style.opacity = "0";
        setTimeout(() => splash.remove(), 600);
    }, 800);
});

/* Micro toggle */
micBtn.onclick = async () => {

    if (!isRecording) {

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {

            statusDiv.innerText = "TRAITEMENT...";
            micBtn.classList.remove("listening");

            const blob = new Blob(audioChunks, { type: "audio/webm" });

            const formData = new FormData();
            formData.append("file", blob);
            formData.append("token", TOKEN);

            try {

                const response = await fetch("/voice", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();

                console.log("DATA RECEIVED:", data);

                responseDiv.innerText = data.response || "";

                if (data.user_emotion) {
                    stateDiv.innerText = data.user_emotion.toUpperCase();
                    applyEmotionColor(data.user_emotion.toLowerCase());
                } else {
                    stateDiv.innerText = "NEUTRE";
                    applyEmotionColor("neutre");
                }

                statusDiv.innerText = data.state
                    ? data.state.toUpperCase()
                    : "CALME";

                if (data.response) {
                    const utter = new SpeechSynthesisUtterance(data.response);
                    utter.lang = "fr-FR";
                    speechSynthesis.speak(utter);
                }

            } catch (err) {
                statusDiv.innerText = "ERREUR";
                console.error(err);
            }

            isRecording = false;
        };

        // üî• CE QUI MANQUAIT
        mediaRecorder.start();
        micBtn.classList.add("listening");
        statusDiv.innerText = "√âCOUTE...";
        isRecording = true;

    } else {
        mediaRecorder.stop();
    }

};

/* Service Worker */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/static/service-worker.js")
    .then(() => console.log("SW registered"))
    .catch((e) => console.log("SW error", e));
}

function applyEmotionColor(emotion) {

    const map = {
        "motiv√©": "#1f6feb",
        "stress√©": "#ff8c42",
        "frustr√©": "#ff4c4c",
        "fatigu√©": "#6c757d",
        "heureux": "#2ecc71",
        "neutre": "#0f111a"
    };

    document.body.style.background = map[emotion] || "#0f111a";
}
</script>

</body>
</html>
